
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>action_type: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">ontology-manager/drivenadapters/action_type/action_type_access.go (82.9%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package action_type

import (
        "context"
        "database/sql"
        "fmt"
        "sync"

        sq "github.com/Masterminds/squirrel"
        "github.com/bytedance/sonic"
        "github.com/kweaver-ai/TelemetrySDK-Go/exporter/v2/ar_trace"
        libCommon "github.com/kweaver-ai/kweaver-go-lib/common"
        libdb "github.com/kweaver-ai/kweaver-go-lib/db"
        "github.com/kweaver-ai/kweaver-go-lib/logger"
        o11y "github.com/kweaver-ai/kweaver-go-lib/observability"
        attr "go.opentelemetry.io/otel/attribute"
        "go.opentelemetry.io/otel/codes"
        "go.opentelemetry.io/otel/trace"

        "ontology-manager/common"
        "ontology-manager/interfaces"
)

const (
        AT_TABLE_NAME = "t_action_type"
)

var (
        atAccessOnce sync.Once
        atAccess     interfaces.ActionTypeAccess
)

type actionTypeAccess struct {
        appSetting *common.AppSetting
        db         *sql.DB
}

func NewActionTypeAccess(appSetting *common.AppSetting) interfaces.ActionTypeAccess <span class="cov0" title="0">{
        atAccessOnce.Do(func() </span><span class="cov0" title="0">{
                atAccess = &amp;actionTypeAccess{
                        appSetting: appSetting,
                        db:         libdb.NewDB(&amp;appSetting.DBSetting),
                }
        }</span>)
        <span class="cov0" title="0">return atAccess</span>
}

// 根据ID获取行动类存在性
func (ata *actionTypeAccess) CheckActionTypeExistByID(ctx context.Context,
        knID string, branch string, atID string) (string, bool, error) <span class="cov8" title="1">{
        ctx, span := ar_trace.Tracer.Start(ctx, "Query action type",
                trace.WithSpanKind(trace.SpanKindClient))
        defer span.End()

        span.SetAttributes(
                attr.Key("db_url").String(libdb.GetDBUrl()),
                attr.Key("db_type").String(libdb.GetDBType()))

        //查询
        sqlStr, vals, err := sq.Select(
                "f_name").
                From(AT_TABLE_NAME).
                Where(sq.Eq{"f_kn_id": knID}).
                Where(sq.Eq{"f_branch": branch}).
                Where(sq.Eq{"f_id": atID}).
                ToSql()
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to build the sql of get action type id by f_id, error: %s", err.Error())
                o11y.Error(ctx, fmt.Sprintf("Failed to build the sql of get action type id by f_id, error: %s", err.Error()))
                span.SetStatus(codes.Error, "Build sql failed ")
                return "", false, err
        }</span>

        // 记录处理的 sql 字符串
        <span class="cov8" title="1">o11y.Info(ctx, fmt.Sprintf("获取行动类信息的 sql 语句: %s", sqlStr))

        var name string
        err = ata.db.QueryRow(sqlStr, vals...).Scan(&amp;name)
        if err == sql.ErrNoRows </span><span class="cov8" title="1">{
                span.SetAttributes(attr.Key("no_rows").Bool(true))
                span.SetStatus(codes.Ok, "")
                return "", false, nil
        }</span> else<span class="cov8" title="1"> if err != nil </span><span class="cov8" title="1">{
                logger.Errorf("row scan failed, err: %v\n", err)
                o11y.Error(ctx, fmt.Sprintf("Row scan failed, err: %v", err))
                span.SetStatus(codes.Error, "Row scan failed ")
                return "", false, err
        }</span>

        <span class="cov8" title="1">span.SetStatus(codes.Ok, "")
        return name, true, nil</span>
}

// 根据名称获取行动类存在性
func (ata *actionTypeAccess) CheckActionTypeExistByName(ctx context.Context,
        knID string, branch string, atName string) (string, bool, error) <span class="cov8" title="1">{
        ctx, span := ar_trace.Tracer.Start(ctx, "Query action type", trace.WithSpanKind(trace.SpanKindClient))
        defer span.End()

        span.SetAttributes(
                attr.Key("db_url").String(libdb.GetDBUrl()),
                attr.Key("db_type").String(libdb.GetDBType()))

        //查询
        sqlStr, vals, err := sq.Select(
                "f_id").
                From(AT_TABLE_NAME).
                Where(sq.Eq{"f_kn_id": knID}).
                Where(sq.Eq{"f_branch": branch}).
                Where(sq.Eq{"f_name": atName}).
                ToSql()
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to build the sql of get id by name, error: %s", err.Error())
                o11y.Error(ctx, fmt.Sprintf("Failed to build the sql of get id by name, error: %s", err.Error()))
                span.SetStatus(codes.Error, "Build sql failed ")
                return "", false, err
        }</span>

        // 记录处理的 sql 字符串
        <span class="cov8" title="1">o11y.Info(ctx, fmt.Sprintf("获取行动类信息的 sql 语句: %s", sqlStr))

        var atID string
        err = ata.db.QueryRow(sqlStr, vals...).Scan(
                &amp;atID,
        )
        if err == sql.ErrNoRows </span><span class="cov8" title="1">{
                span.SetAttributes(attr.Key("no_rows").Bool(true))
                span.SetStatus(codes.Ok, "")
                return "", false, nil
        }</span> else<span class="cov8" title="1"> if err != nil </span><span class="cov8" title="1">{
                logger.Errorf("row scan failed, err: %v\n", err)
                o11y.Error(ctx, fmt.Sprintf("Row scan failed, err: %v", err))
                span.SetStatus(codes.Error, "Row scan failed ")
                return "", false, err
        }</span>

        <span class="cov8" title="1">span.SetStatus(codes.Ok, "")
        return atID, true, nil</span>
}

// 创建行动类
func (ata *actionTypeAccess) CreateActionType(ctx context.Context, tx *sql.Tx, actionType *interfaces.ActionType) error <span class="cov8" title="1">{
        ctx, span := ar_trace.Tracer.Start(ctx, "Insert into action type", trace.WithSpanKind(trace.SpanKindClient))
        defer span.End()

        span.SetAttributes(
                attr.Key("db_url").String(libdb.GetDBUrl()),
                attr.Key("db_type").String(libdb.GetDBType()))

        // tags 转成 string 的格式
        tagsStr := libCommon.TagSlice2TagString(actionType.Tags)

        // 2.0 序列化 condition
        conditionBytes, err := sonic.Marshal(actionType.Condition)
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to marshal Condition, err: %v", err.Error())
                return err
        }</span>

        // 2.1 序列化 affect
        <span class="cov8" title="1">affectBytes, err := sonic.Marshal(actionType.Affect)
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to marshal Affect, err: %v", err.Error())
                return err
        }</span>

        // 2.2 序列化 action_source
        <span class="cov8" title="1">actionSourceBytes, err := sonic.Marshal(actionType.ActionSource)
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to marshal ActionSource, err: %v", err.Error())
                return err
        }</span>

        // 2.3 序列化 parameters
        <span class="cov8" title="1">parameterBytes, err := sonic.Marshal(actionType.Parameters)
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to marshal Parameters, err: %v", err.Error())
                return err
        }</span>

        // 2.4 序列化 schedule
        <span class="cov8" title="1">scheduleBytes, err := sonic.Marshal(actionType.Schedule)
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to marshal Schedule, err: %v", err.Error())
                return err
        }</span>

        <span class="cov8" title="1">sqlStr, vals, err := sq.Insert(AT_TABLE_NAME).
                Columns(
                        "f_id",
                        "f_name",
                        "f_tags",
                        "f_comment",
                        "f_icon",
                        "f_color",
                        "f_detail",
                        "f_kn_id",
                        "f_branch",
                        "f_action_type",
                        "f_object_type_id",
                        "f_condition",
                        "f_affect",
                        "f_action_source",
                        "f_parameters",
                        "f_schedule",
                        "f_creator",
                        "f_creator_type",
                        "f_create_time",
                        "f_updater",
                        "f_updater_type",
                        "f_update_time",
                ).
                Values(
                        actionType.ATID,
                        actionType.ATName,
                        tagsStr,
                        actionType.Comment,
                        actionType.Icon,
                        actionType.Color,
                        actionType.Detail,
                        actionType.KNID,
                        actionType.Branch,
                        actionType.ActionType,
                        actionType.ObjectTypeID,
                        conditionBytes,
                        affectBytes,
                        actionSourceBytes,
                        parameterBytes,
                        scheduleBytes,
                        actionType.Creator.ID,
                        actionType.Creator.Type,
                        actionType.CreateTime,
                        actionType.Updater.ID,
                        actionType.Updater.Type,
                        actionType.UpdateTime).
                ToSql()
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to build the sql of insert action type, error: %s", err.Error())
                o11y.Error(ctx, fmt.Sprintf("Failed to build the sql of insert action type, error: %s", err.Error()))
                span.SetStatus(codes.Error, "Build sql failed ")
                return err
        }</span>
        // 记录处理的 sql 字符串
        <span class="cov8" title="1">o11y.Info(ctx, fmt.Sprintf("创建行动类的 sql 语句: %s", sqlStr))

        _, err = tx.Exec(sqlStr, vals...)
        if err != nil </span><span class="cov8" title="1">{
                logger.Errorf("insert data error: %v\n", err)
                span.SetStatus(codes.Error, "Insert data error")
                o11y.Error(ctx, fmt.Sprintf("Insert data error: %v ", err))
                return err
        }</span>

        <span class="cov8" title="1">span.SetStatus(codes.Ok, "")
        return nil</span>
}

// 查询行动类列表。查主线的当前版本为true的行动类
func (ata *actionTypeAccess) ListActionTypes(ctx context.Context, query interfaces.ActionTypesQueryParams) ([]*interfaces.ActionType, error) <span class="cov8" title="1">{
        ctx, span := ar_trace.Tracer.Start(ctx, "Select action types", trace.WithSpanKind(trace.SpanKindClient))
        defer span.End()

        span.SetAttributes(
                attr.Key("db_url").String(libdb.GetDBUrl()),
                attr.Key("db_type").String(libdb.GetDBType()))

        subBuilder := sq.Select(
                "f_id",
                "f_name",
                "f_tags",
                "f_comment",
                "f_icon",
                "f_color",
                "f_detail",
                "f_kn_id",
                "f_branch",
                "f_action_type",
                "f_object_type_id",
                "f_condition",
                "f_affect",
                "f_action_source",
                "f_parameters",
                "f_schedule",
                "f_creator",
                "f_creator_type",
                "f_create_time",
                "f_updater",
                "f_updater_type",
                "f_update_time").
                From(AT_TABLE_NAME)

        builder := processQueryCondition(query, subBuilder)

        //排序
        if query.Sort != "" </span><span class="cov8" title="1">{
                builder = builder.OrderBy(fmt.Sprintf("%s %s", query.Sort, query.Direction))
        }</span>

        <span class="cov8" title="1">sqlStr, vals, err := builder.ToSql()
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to build the sql of select action types, error: %s", err.Error())
                o11y.Error(ctx, fmt.Sprintf("Failed to build the sql of select action types, error: %s", err.Error()))
                span.SetStatus(codes.Error, "Build sql failed ")
                return []*interfaces.ActionType{}, err
        }</span>

        // 记录处理的 sql 字符串
        <span class="cov8" title="1">o11y.Info(ctx, fmt.Sprintf("查询行动类列表的 sql 语句: %s; queryParams: %v", sqlStr, query))

        rows, err := ata.db.Query(sqlStr, vals...)
        if err != nil </span><span class="cov8" title="1">{
                logger.Errorf("list data error: %v\n", err)
                o11y.Error(ctx, fmt.Sprintf("List data error: %v", err))
                span.SetStatus(codes.Error, "List data error")
                return []*interfaces.ActionType{}, err
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        actionTypes := make([]*interfaces.ActionType, 0)
        for rows.Next() </span><span class="cov8" title="1">{
                actionType := interfaces.ActionType{
                        ModuleType: interfaces.MODULE_TYPE_ACTION_TYPE,
                }
                tagsStr := ""
                var (
                        conditionBytes    []byte
                        affectBytes       []byte
                        actionSourceBytes []byte
                        parametersBytes   []byte
                        scheduleBytes     []byte
                )
                err := rows.Scan(
                        &amp;actionType.ATID,
                        &amp;actionType.ATName,
                        &amp;tagsStr,
                        &amp;actionType.Comment,
                        &amp;actionType.Icon,
                        &amp;actionType.Color,
                        &amp;actionType.Detail,
                        &amp;actionType.KNID,
                        &amp;actionType.Branch,
                        &amp;actionType.ActionType,
                        &amp;actionType.ObjectTypeID,
                        &amp;conditionBytes,
                        &amp;affectBytes,
                        &amp;actionSourceBytes,
                        &amp;parametersBytes,
                        &amp;scheduleBytes,
                        &amp;actionType.Creator.ID,
                        &amp;actionType.Creator.Type,
                        &amp;actionType.CreateTime,
                        &amp;actionType.Updater.ID,
                        &amp;actionType.Updater.Type,
                        &amp;actionType.UpdateTime,
                )
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("row scan failed, err: %v \n", err)
                        o11y.Error(ctx, fmt.Sprintf("Row scan error: %v", err))
                        span.SetStatus(codes.Error, "Row scan error")
                        return []*interfaces.ActionType{}, err
                }</span>

                // tags string 转成数组的格式
                <span class="cov8" title="1">actionType.Tags = libCommon.TagString2TagSlice(tagsStr)

                // 2.0 反序列化 condition
                err = sonic.Unmarshal(conditionBytes, &amp;actionType.Condition)
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("Failed to unmarshal Condition after getting action type, err: %v", err.Error())
                        o11y.Error(ctx, fmt.Sprintf("Failed to unmarshal Condition after getting action type, err: %v", err.Error()))
                        span.SetStatus(codes.Error, "Failed to unmarshal Condition after getting action type")
                        return []*interfaces.ActionType{}, err
                }</span>
                // 2.1 反序列化 affect
                <span class="cov8" title="1">err = sonic.Unmarshal(affectBytes, &amp;actionType.Affect)
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("Failed to unmarshal Affect after getting action type, err: %v", err.Error())
                        o11y.Error(ctx, fmt.Sprintf("Failed to unmarshal Affect after getting action type, err: %v", err.Error()))
                        span.SetStatus(codes.Error, "Failed to unmarshal Affect after getting action type")
                        return []*interfaces.ActionType{}, err
                }</span>
                // 2.2 反序列化  action_source
                <span class="cov8" title="1">err = sonic.Unmarshal(actionSourceBytes, &amp;actionType.ActionSource)
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("Failed to unmarshal ActionSource after getting action type, err: %v", err.Error())
                        o11y.Error(ctx, fmt.Sprintf("Failed to unmarshal ActionSource after getting action type, err: %v", err.Error()))
                        span.SetStatus(codes.Error, "Failed to unmarshal ActionSource after getting action type")
                        return []*interfaces.ActionType{}, err
                }</span>
                // 2.3 反序列化  parameters
                <span class="cov8" title="1">err = sonic.Unmarshal(parametersBytes, &amp;actionType.Parameters)
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("Failed to unmarshal Parameters after getting action type, err: %v", err.Error())
                        o11y.Error(ctx, fmt.Sprintf("Failed to unmarshal Parameters after getting action type, err: %v", err.Error()))
                        span.SetStatus(codes.Error, "Failed to unmarshal Parameters after getting action type")
                        return []*interfaces.ActionType{}, err
                }</span>
                // 2.4 反序列化 schedule
                <span class="cov8" title="1">err = sonic.Unmarshal(scheduleBytes, &amp;actionType.Schedule)
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("Failed to unmarshal Schedule after getting action type, err: %v", err.Error())
                        o11y.Error(ctx, fmt.Sprintf("Failed to unmarshal Schedule after getting action type, err: %v", err.Error()))
                        span.SetStatus(codes.Error, "Failed to unmarshal Schedule after getting action type")
                        return []*interfaces.ActionType{}, err
                }</span>

                <span class="cov8" title="1">actionTypes = append(actionTypes, &amp;actionType)</span>
        }

        <span class="cov8" title="1">span.SetStatus(codes.Ok, "")
        return actionTypes, nil</span>
}

func (ata *actionTypeAccess) GetActionTypesTotal(ctx context.Context, query interfaces.ActionTypesQueryParams) (int, error) <span class="cov8" title="1">{
        ctx, span := ar_trace.Tracer.Start(ctx, "Select action types total number", trace.WithSpanKind(trace.SpanKindClient))
        defer span.End()

        span.SetAttributes(
                attr.Key("db_url").String(libdb.GetDBUrl()),
                attr.Key("db_type").String(libdb.GetDBType()))

        subBuilder := sq.Select("COUNT(f_id)").From(AT_TABLE_NAME)
        builder := processQueryCondition(query, subBuilder)
        sqlStr, vals, err := builder.ToSql()
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to build the sql of select action types total, error: %s", err.Error())
                o11y.Error(ctx, fmt.Sprintf("Failed to build the sql of select action types total, error: %s", err.Error()))
                span.SetStatus(codes.Error, "Build sql failed ")
                return 0, err
        }</span>

        // 记录处理的 sql 字符串
        <span class="cov8" title="1">o11y.Info(ctx, fmt.Sprintf("查询行动类总数的 sql 语句: %s; queryParams: %v", sqlStr, query))

        total := 0
        err = ata.db.QueryRow(sqlStr, vals...).Scan(&amp;total)
        if err != nil </span><span class="cov8" title="1">{
                logger.Errorf("get action type total error: %v\n", err)
                o11y.Error(ctx, fmt.Sprintf("Get action type total error: %v", err))
                span.SetStatus(codes.Error, "Get action type total error")
                return 0, err
        }</span>

        <span class="cov8" title="1">span.SetStatus(codes.Ok, "")
        return total, nil</span>
}

func (ata *actionTypeAccess) GetActionTypesByIDs(ctx context.Context,
        knID string, branch string, atIDs []string) ([]*interfaces.ActionType, error) <span class="cov8" title="1">{
        ctx, span := ar_trace.Tracer.Start(ctx, fmt.Sprintf("Get action type[%s]", atIDs),
                trace.WithSpanKind(trace.SpanKindClient))
        defer span.End()

        span.SetAttributes(
                attr.Key("db_url").String(libdb.GetDBUrl()),
                attr.Key("db_type").String(libdb.GetDBType()))

        //查询
        sqlStr, vals, err := sq.Select(
                "f_id",
                "f_name",
                "f_tags",
                "f_comment",
                "f_icon",
                "f_color",
                "f_detail",
                "f_kn_id",
                "f_branch",
                "f_action_type",
                "f_object_type_id",
                "f_condition",
                "f_affect",
                "f_action_source",
                "f_parameters",
                "f_schedule",
                "f_creator",
                "f_creator_type",
                "f_create_time",
                "f_updater",
                "f_updater_type",
                "f_update_time",
        ).From(AT_TABLE_NAME).
                Where(sq.Eq{"f_kn_id": knID}).
                Where(sq.Eq{"f_branch": branch}).
                Where(sq.Eq{"f_id": atIDs}).
                ToSql()
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to build the sql of select action type by id, error: %s", err.Error())
                o11y.Error(ctx, fmt.Sprintf("Failed to build the sql of select action type by id, error: %s", err.Error()))
                span.SetStatus(codes.Error, "Build sql failed ")
                return []*interfaces.ActionType{}, err
        }</span>

        // 记录处理的 sql 字符串
        <span class="cov8" title="1">o11y.Info(ctx, fmt.Sprintf("查询行动类列表的 sql 语句: %s.", sqlStr))
        rows, err := ata.db.Query(sqlStr, vals...)
        if err != nil </span><span class="cov8" title="1">{
                logger.Errorf("list data error: %v\n", err)
                o11y.Error(ctx, fmt.Sprintf("List data error: %v", err))
                span.SetStatus(codes.Error, "List data error")
                return []*interfaces.ActionType{}, err
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        actionTypes := make([]*interfaces.ActionType, 0)
        for rows.Next() </span><span class="cov8" title="1">{
                actionType := interfaces.ActionType{
                        ModuleType: interfaces.MODULE_TYPE_ACTION_TYPE,
                }
                tagsStr := ""
                var (
                        conditionBytes    []byte
                        affectBytes       []byte
                        actionSourceBytes []byte
                        parametersBytes   []byte
                        scheduleBytes     []byte
                )

                err := rows.Scan(
                        &amp;actionType.ATID,
                        &amp;actionType.ATName,
                        &amp;tagsStr,
                        &amp;actionType.Comment,
                        &amp;actionType.Icon,
                        &amp;actionType.Color,
                        &amp;actionType.Detail,
                        &amp;actionType.KNID,
                        &amp;actionType.Branch,
                        &amp;actionType.ActionType,
                        &amp;actionType.ObjectTypeID,
                        &amp;conditionBytes,
                        &amp;affectBytes,
                        &amp;actionSourceBytes,
                        &amp;parametersBytes,
                        &amp;scheduleBytes,
                        &amp;actionType.Creator.ID,
                        &amp;actionType.Creator.Type,
                        &amp;actionType.CreateTime,
                        &amp;actionType.Updater.ID,
                        &amp;actionType.Updater.Type,
                        &amp;actionType.UpdateTime,
                )

                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("row scan failed, err: %v \n", err)
                        o11y.Error(ctx, fmt.Sprintf("Row scan error: %v", err))
                        span.SetStatus(codes.Error, "Row scan error")
                        return []*interfaces.ActionType{}, err
                }</span>

                // tags string 转成数组的格式
                <span class="cov8" title="1">actionType.Tags = libCommon.TagString2TagSlice(tagsStr)

                // 2.0 反序列化 condition
                err = sonic.Unmarshal(conditionBytes, &amp;actionType.Condition)
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("Failed to unmarshal Condition after getting action type, err: %v", err.Error())
                        o11y.Error(ctx, fmt.Sprintf("Failed to unmarshal Condition after getting action type, err: %v", err.Error()))
                        span.SetStatus(codes.Error, "Failed to unmarshal Condition after getting action type")
                        return []*interfaces.ActionType{}, err
                }</span>
                // 2.1 反序列化 affect
                <span class="cov8" title="1">err = sonic.Unmarshal(affectBytes, &amp;actionType.Affect)
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("Failed to unmarshal Affect after getting action type, err: %v", err.Error())
                        o11y.Error(ctx, fmt.Sprintf("Failed to unmarshal Affect after getting action type, err: %v", err.Error()))
                        span.SetStatus(codes.Error, "Failed to unmarshal Affect after getting action type")
                        return []*interfaces.ActionType{}, err
                }</span>
                // 2.2 反序列化  action_source
                <span class="cov8" title="1">err = sonic.Unmarshal(actionSourceBytes, &amp;actionType.ActionSource)
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("Failed to unmarshal ActionSource after getting action type, err: %v", err.Error())
                        o11y.Error(ctx, fmt.Sprintf("Failed to unmarshal ActionSource after getting action type, err: %v", err.Error()))
                        span.SetStatus(codes.Error, "Failed to unmarshal ActionSource after getting action type")
                        return []*interfaces.ActionType{}, err
                }</span>
                // 2.3 反序列化  parameters
                <span class="cov8" title="1">err = sonic.Unmarshal(parametersBytes, &amp;actionType.Parameters)
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("Failed to unmarshal Parameters after getting action type, err: %v", err.Error())
                        o11y.Error(ctx, fmt.Sprintf("Failed to unmarshal Parameters after getting action type, err: %v", err.Error()))
                        span.SetStatus(codes.Error, "Failed to unmarshal Parameters after getting action type")
                        return []*interfaces.ActionType{}, err
                }</span>
                // 2.4 反序列化 schedule
                <span class="cov8" title="1">err = sonic.Unmarshal(scheduleBytes, &amp;actionType.Schedule)
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("Failed to unmarshal Schedule after getting action type, err: %v", err.Error())
                        o11y.Error(ctx, fmt.Sprintf("Failed to unmarshal Schedule after getting action type, err: %v", err.Error()))
                        span.SetStatus(codes.Error, "Failed to unmarshal Schedule after getting action type")
                        return []*interfaces.ActionType{}, err
                }</span>

                <span class="cov8" title="1">actionTypes = append(actionTypes, &amp;actionType)</span>
        }

        <span class="cov8" title="1">span.SetStatus(codes.Ok, "")
        return actionTypes, nil</span>
}

func (ata *actionTypeAccess) UpdateActionType(ctx context.Context, tx *sql.Tx, actionType *interfaces.ActionType) error <span class="cov8" title="1">{
        ctx, span := ar_trace.Tracer.Start(ctx, fmt.Sprintf("Update action type[%s]", actionType.ATID), trace.WithSpanKind(trace.SpanKindClient))
        defer span.End()

        span.SetAttributes(
                attr.Key("db_url").String(libdb.GetDBUrl()),
                attr.Key("db_type").String(libdb.GetDBType()))

        // tags 转成 string 的格式
        tagsStr := libCommon.TagSlice2TagString(actionType.Tags)
        // 2.0 序列化 condition
        conditionBytes, err := sonic.Marshal(actionType.Condition)
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to marshal Condition, err: %v", err.Error())
                o11y.Error(ctx, fmt.Sprintf("Failed to marshal Condition, err: %v", err.Error()))
                span.SetStatus(codes.Error, "Failed to marshal Condition")
                return err
        }</span>

        // 2.1 序列化 affect
        <span class="cov8" title="1">affectBytes, err := sonic.Marshal(actionType.Affect)
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to marshal Affect, err: %v", err.Error())
                o11y.Error(ctx, fmt.Sprintf("Failed to marshal Affect, err: %v", err.Error()))
                span.SetStatus(codes.Error, "Failed to marshal Affect")
                return err
        }</span>

        // 2.2 序列化 action_source
        <span class="cov8" title="1">actionSourceBytes, err := sonic.Marshal(actionType.ActionSource)
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to marshal ActionSource, err: %v", err.Error())
                o11y.Error(ctx, fmt.Sprintf("Failed to marshal ActionSource, err: %v", err.Error()))
                span.SetStatus(codes.Error, "Failed to marshal ActionSource")
                return err
        }</span>

        // 2.3 序列化 parameters
        <span class="cov8" title="1">parameterBytes, err := sonic.Marshal(actionType.Parameters)
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to marshal Parameters, err: %v", err.Error())
                o11y.Error(ctx, fmt.Sprintf("Failed to marshal Parameters, err: %v", err.Error()))
                span.SetStatus(codes.Error, "Failed to marshal Parameters")
                return err
        }</span>

        // 2.4 序列化 schedule
        <span class="cov8" title="1">scheduleBytes, err := sonic.Marshal(actionType.Schedule)
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to marshal Schedule, err: %v", err.Error())
                o11y.Error(ctx, fmt.Sprintf("Failed to marshal Schedule, err: %v", err.Error()))
                span.SetStatus(codes.Error, "Failed to marshal Schedule")
                return err
        }</span>

        <span class="cov8" title="1">data := map[string]any{
                "f_name":           actionType.ATName,
                "f_tags":           tagsStr,
                "f_comment":        actionType.Comment,
                "f_icon":           actionType.Icon,
                "f_color":          actionType.Color,
                "f_action_type":    actionType.ActionType,
                "f_object_type_id": actionType.ObjectTypeID,
                "f_condition":      conditionBytes,
                "f_affect":         affectBytes,
                "f_action_source":  actionSourceBytes,
                "f_parameters":     parameterBytes,
                "f_schedule":       scheduleBytes,
                "f_updater":        actionType.Updater.ID,
                "f_updater_type":   actionType.Updater.Type,
                "f_update_time":    actionType.UpdateTime,
        }
        sqlStr, vals, err := sq.Update(AT_TABLE_NAME).
                SetMap(data).
                Where(sq.Eq{"f_id": actionType.ATID}).
                Where(sq.Eq{"f_kn_id": actionType.KNID}).
                ToSql()
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to build the sql of update action type by action type id, error: %s", err.Error())
                o11y.Error(ctx, fmt.Sprintf("Failed to build the sql of update action type by action type id, error: %s", err.Error()))
                span.SetStatus(codes.Error, "Build sql failed ")
                return err
        }</span>

        // 记录处理的 sql 字符串
        <span class="cov8" title="1">o11y.Info(ctx, fmt.Sprintf("修改行动类的 sql 语句: %s", sqlStr))

        ret, err := tx.Exec(sqlStr, vals...)
        if err != nil </span><span class="cov8" title="1">{
                logger.Errorf("update action type error: %v\n", err)
                o11y.Error(ctx, fmt.Sprintf("Update data error: %v ", err))
                span.SetStatus(codes.Error, "Update data error")
                return err
        }</span>

        //sql语句影响的行数
        <span class="cov8" title="1">RowsAffected, err := ret.RowsAffected()
        if err != nil </span><span class="cov8" title="1">{
                logger.Errorf("Get RowsAffected error: %v\n", err)
                o11y.Warn(ctx, fmt.Sprintf("Get RowsAffected error: %v ", err))
                span.SetStatus(codes.Error, "Get RowsAffected error")
                return err
        }</span>

        <span class="cov8" title="1">if RowsAffected != 1 </span><span class="cov8" title="1">{
                // 影响行数不等于1不报错，更新操作已经发生
                logger.Errorf("UPDATE %d RowsAffected not equal 1, RowsAffected is %d, ActionType is %v",
                        actionType.ATID, RowsAffected, actionType)
                o11y.Warn(ctx, fmt.Sprintf("Update %s RowsAffected not equal 1, RowsAffected is %d, ActionType is %v",
                        actionType.ATID, RowsAffected, actionType))
        }</span>

        <span class="cov8" title="1">span.SetStatus(codes.Ok, "")
        return nil</span>
}

func (ata *actionTypeAccess) DeleteActionTypesByIDs(ctx context.Context,
        tx *sql.Tx, knID string, branch string, atIDs []string) (int64, error) <span class="cov8" title="1">{
        ctx, span := ar_trace.Tracer.Start(ctx, "Delete action types from db", trace.WithSpanKind(trace.SpanKindClient))
        defer span.End()

        span.SetAttributes(
                attr.Key("db_url").String(libdb.GetDBUrl()),
                attr.Key("db_type").String(libdb.GetDBType()),
                attr.Key("kn_id").String(knID),
                attr.Key("branch").String(branch),
                attr.Key("at_ids").String(fmt.Sprintf("%v", atIDs)))

        if len(atIDs) == 0 </span><span class="cov8" title="1">{
                return 0, nil
        }</span>

        <span class="cov8" title="1">sqlStr, vals, err := sq.Delete(AT_TABLE_NAME).
                Where(sq.Eq{"f_kn_id": knID}).
                Where(sq.Eq{"f_branch": branch}).
                Where(sq.Eq{"f_id": atIDs}).
                ToSql()
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to build the sql of delete action type by action type id, error: %s", err.Error())
                o11y.Error(ctx, fmt.Sprintf("Failed to build the sql of delete action type by action type id, error: %s", err.Error()))
                span.SetStatus(codes.Error, "Build sql failed ")
                return 0, err
        }</span>

        // 记录处理的 sql 字符串
        <span class="cov8" title="1">o11y.Info(ctx, fmt.Sprintf("删除行动类的 sql 语句: %s; 删除的行动类ids: %v", sqlStr, atIDs))

        ret, err := tx.Exec(sqlStr, vals...)
        if err != nil </span><span class="cov8" title="1">{
                logger.Errorf("delete data error: %v\n", err)
                o11y.Error(ctx, fmt.Sprintf("Delete data error: %v ", err))
                span.SetStatus(codes.Error, "Delete data error")
                return 0, err
        }</span>

        //sql语句影响的行数
        <span class="cov8" title="1">RowsAffected, err := ret.RowsAffected()
        if err != nil </span><span class="cov8" title="1">{
                logger.Errorf("Get RowsAffected error: %v\n", err)
                o11y.Warn(ctx, fmt.Sprintf("Get RowsAffected error: %v ", err))
                span.SetStatus(codes.Error, "Get RowsAffected error")
        }</span>

        <span class="cov8" title="1">logger.Infof("RowsAffected: %d", RowsAffected)
        span.SetStatus(codes.Ok, "")
        return RowsAffected, nil</span>
}

func (ata *actionTypeAccess) GetActionTypeIDsByKnID(ctx context.Context,
        knID string, branch string) ([]string, error) <span class="cov8" title="1">{
        ctx, span := ar_trace.Tracer.Start(ctx, fmt.Sprintf("Get action type ids by kn_id[%s]", knID), trace.WithSpanKind(trace.SpanKindClient))
        defer span.End()

        span.SetAttributes(
                attr.Key("db_url").String(libdb.GetDBUrl()),
                attr.Key("db_type").String(libdb.GetDBType()),
                attr.Key("kn_id").String(knID),
                attr.Key("branch").String(branch))

        //查询
        sqlStr, vals, err := sq.Select(
                "f_id",
        ).From(AT_TABLE_NAME).
                Where(sq.Eq{"f_kn_id": knID}).
                Where(sq.Eq{"f_branch": branch}).
                ToSql()
        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to build the sql of select action type ids by kn_id, error: %s", err.Error())
                o11y.Error(ctx, fmt.Sprintf("Failed to build the sql of select action type ids by kn_id, error: %s", err.Error()))
                span.SetStatus(codes.Error, "Build sql failed ")
                return nil, err
        }</span>

        // 记录处理的 sql 字符串
        <span class="cov8" title="1">o11y.Info(ctx, fmt.Sprintf("查询行动类的 sql 语句: %s.", sqlStr))
        rows, err := ata.db.Query(sqlStr, vals...)
        if err != nil </span><span class="cov8" title="1">{
                logger.Errorf("list data error: %v\n", err)
                o11y.Error(ctx, fmt.Sprintf("List data error: %v", err))
                span.SetStatus(codes.Error, "List data error")
                return nil, err
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        atIDs := []string{}
        for rows.Next() </span><span class="cov8" title="1">{

                var atID string
                err := rows.Scan(
                        &amp;atID,
                )
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("row scan failed, err: %v \n", err)
                        o11y.Error(ctx, fmt.Sprintf("Row scan error: %v", err))
                        span.SetStatus(codes.Error, "Row scan error")
                        return nil, err
                }</span>

                <span class="cov8" title="1">atIDs = append(atIDs, atID)</span>
        }

        <span class="cov8" title="1">span.SetStatus(codes.Ok, "")
        return atIDs, nil</span>
}

// 拼接 sql 过滤条件
func processQueryCondition(query interfaces.ActionTypesQueryParams, subBuilder sq.SelectBuilder) sq.SelectBuilder <span class="cov8" title="1">{
        if query.NamePattern != "" </span><span class="cov8" title="1">{
                // 模糊查询
                subBuilder = subBuilder.Where(sq.Expr("instr(f_name, ?) &gt; 0", query.NamePattern))
        }</span>

        <span class="cov8" title="1">if query.Tag != "" </span><span class="cov8" title="1">{
                subBuilder = subBuilder.Where(sq.Expr("instr(f_tags, ?) &gt; 0", `"`+query.Tag+`"`))
        }</span>

        <span class="cov8" title="1">if query.KNID != "" </span><span class="cov8" title="1">{
                subBuilder = subBuilder.Where(sq.Eq{"f_kn_id": query.KNID})
        }</span>

        <span class="cov8" title="1">if query.Branch != "" </span><span class="cov8" title="1">{
                subBuilder = subBuilder.Where(sq.Eq{"f_branch": query.Branch})
        }</span> else<span class="cov8" title="1"> {
                // 查主线分支的业务知识网络
                subBuilder = subBuilder.Where(sq.Eq{"f_branch": interfaces.MAIN_BRANCH})
        }</span>

        <span class="cov8" title="1">if query.ActionType != "" </span><span class="cov8" title="1">{
                subBuilder = subBuilder.Where(sq.Eq{"f_action_type": query.ActionType})
        }</span>

        <span class="cov8" title="1">if len(query.ObjectTypeIDs) &gt; 0 </span><span class="cov8" title="1">{
                subBuilder = subBuilder.Where(sq.Eq{"f_object_type_id": query.ObjectTypeIDs})
        }</span>

        <span class="cov8" title="1">return subBuilder</span>
}

// 查询行动类列表。查主线的当前版本为true的行动类
func (ata *actionTypeAccess) GetAllActionTypesByKnID(ctx context.Context,
        knID string, branch string) (map[string]*interfaces.ActionType, error) <span class="cov8" title="1">{
        ctx, span := ar_trace.Tracer.Start(ctx, fmt.Sprintf("Select action types by kn_id[%s]", knID), trace.WithSpanKind(trace.SpanKindClient))
        defer span.End()

        span.SetAttributes(
                attr.Key("db_url").String(libdb.GetDBUrl()),
                attr.Key("db_type").String(libdb.GetDBType()),
                attr.Key("kn_id").String(knID),
                attr.Key("branch").String(branch))

        sqlStr, vals, err := sq.Select(
                "f_id",
                "f_name",
                "f_tags",
                "f_comment",
                "f_icon",
                "f_color",
                "f_detail",
                "f_kn_id",
                "f_branch",
                "f_action_type",
                "f_object_type_id",
                "f_condition",
                "f_affect",
                "f_action_source",
                "f_parameters",
                "f_schedule",
                "f_creator",
                "f_creator_type",
                "f_create_time",
                "f_updater",
                "f_updater_type",
                "f_update_time").
                From(AT_TABLE_NAME).
                Where(sq.Eq{"f_kn_id": knID}).
                Where(sq.Eq{"f_branch": branch}).
                ToSql()

        if err != nil </span><span class="cov0" title="0">{
                logger.Errorf("Failed to build the sql of select action types, error: %s", err.Error())
                o11y.Error(ctx, fmt.Sprintf("Failed to build the sql of select action types, error: %s", err.Error()))
                span.SetStatus(codes.Error, "Build sql failed ")
                return map[string]*interfaces.ActionType{}, err
        }</span>

        // 记录处理的 sql 字符串
        <span class="cov8" title="1">o11y.Info(ctx, fmt.Sprintf("查询行动类列表的 sql 语句: %s.", sqlStr))

        rows, err := ata.db.Query(sqlStr, vals...)
        if err != nil </span><span class="cov8" title="1">{
                logger.Errorf("list data error: %v\n", err)
                o11y.Error(ctx, fmt.Sprintf("List data error: %v", err))
                span.SetStatus(codes.Error, "List data error")
                return map[string]*interfaces.ActionType{}, err
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        actionTypes := make(map[string]*interfaces.ActionType)
        for rows.Next() </span><span class="cov8" title="1">{
                actionType := interfaces.ActionType{
                        ModuleType: interfaces.MODULE_TYPE_ACTION_TYPE,
                }
                tagsStr := ""
                var (
                        conditionBytes    []byte
                        affectBytes       []byte
                        actionSourceBytes []byte
                        parametersBytes   []byte
                        scheduleBytes     []byte
                )
                err := rows.Scan(
                        &amp;actionType.ATID,
                        &amp;actionType.ATName,
                        &amp;tagsStr,
                        &amp;actionType.Comment,
                        &amp;actionType.Icon,
                        &amp;actionType.Color,
                        &amp;actionType.Detail,
                        &amp;actionType.KNID,
                        &amp;actionType.Branch,
                        &amp;actionType.ActionType,
                        &amp;actionType.ObjectTypeID,
                        &amp;conditionBytes,
                        &amp;affectBytes,
                        &amp;actionSourceBytes,
                        &amp;parametersBytes,
                        &amp;scheduleBytes,
                        &amp;actionType.Creator.ID,
                        &amp;actionType.Creator.Type,
                        &amp;actionType.CreateTime,
                        &amp;actionType.Updater.ID,
                        &amp;actionType.Updater.Type,
                        &amp;actionType.UpdateTime,
                )
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("row scan failed, err: %v \n", err)
                        o11y.Error(ctx, fmt.Sprintf("Row scan error: %v", err))
                        span.SetStatus(codes.Error, "Row scan error")
                        return map[string]*interfaces.ActionType{}, err
                }</span>

                // tags string 转成数组的格式
                <span class="cov8" title="1">actionType.Tags = libCommon.TagString2TagSlice(tagsStr)

                // 2.0 反序列化 condition
                err = sonic.Unmarshal(conditionBytes, &amp;actionType.Condition)
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("Failed to unmarshal Condition after getting action type, err: %v", err.Error())
                        o11y.Error(ctx, fmt.Sprintf("Failed to unmarshal Condition after getting action type, err: %v", err.Error()))
                        span.SetStatus(codes.Error, "Failed to unmarshal Condition after getting action type")
                        return map[string]*interfaces.ActionType{}, err
                }</span>
                // 2.1 反序列化 affect
                <span class="cov8" title="1">err = sonic.Unmarshal(affectBytes, &amp;actionType.Affect)
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("Failed to unmarshal Affect after getting action type, err: %v", err.Error())
                        o11y.Error(ctx, fmt.Sprintf("Failed to unmarshal Affect after getting action type, err: %v", err.Error()))
                        span.SetStatus(codes.Error, "Failed to unmarshal Affect after getting action type")
                        return map[string]*interfaces.ActionType{}, err
                }</span>
                // 2.2 反序列化  action_source
                <span class="cov8" title="1">err = sonic.Unmarshal(actionSourceBytes, &amp;actionType.ActionSource)
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("Failed to unmarshal ActionSource after getting action type, err: %v", err.Error())
                        o11y.Error(ctx, fmt.Sprintf("Failed to unmarshal ActionSource after getting action type, err: %v", err.Error()))
                        span.SetStatus(codes.Error, "Failed to unmarshal ActionSource after getting action type")
                        return map[string]*interfaces.ActionType{}, err
                }</span>
                // 2.3 反序列化  parameters
                <span class="cov8" title="1">err = sonic.Unmarshal(parametersBytes, &amp;actionType.Parameters)
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("Failed to unmarshal Parameters after getting action type, err: %v", err.Error())
                        o11y.Error(ctx, fmt.Sprintf("Failed to unmarshal Parameters after getting action type, err: %v", err.Error()))
                        span.SetStatus(codes.Error, "Failed to unmarshal Parameters after getting action type")
                        return map[string]*interfaces.ActionType{}, err
                }</span>
                // 2.4 反序列化 schedule
                <span class="cov8" title="1">err = sonic.Unmarshal(scheduleBytes, &amp;actionType.Schedule)
                if err != nil </span><span class="cov8" title="1">{
                        logger.Errorf("Failed to unmarshal Schedule after getting action type, err: %v", err.Error())
                        o11y.Error(ctx, fmt.Sprintf("Failed to unmarshal Schedule after getting action type, err: %v", err.Error()))
                        span.SetStatus(codes.Error, "Failed to unmarshal Schedule after getting action type")
                        return map[string]*interfaces.ActionType{}, err
                }</span>

                <span class="cov8" title="1">actionTypes[actionType.ATID] = &amp;actionType</span>
        }

        <span class="cov8" title="1">span.SetStatus(codes.Ok, "")
        return actionTypes, nil</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
